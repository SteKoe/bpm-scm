cmd_help() {
    OUTPUT=`git help add -m`
    git_replace "$OUTPUT"
}

cmd_exec() {
    git_do "add" "$@" &> /dev/null
    for PROCESS in $(git diff --name-only --cached | grep ".bpmn$"); do
        add_referenced_processes "$PROCESS"
    done
}

# For a given Process find all references to other Processes and stage them as well
# $1    bpmn file
add_referenced_processes() {
    for REFERENCED_PROCESS_ID in $(get_referenced_process_ids "$1"); do
        REFERENCING_PROCESSES=$(get_referencing_processes "$REFERENCED_PROCESS_ID")
        for REFERENCING_PROCESS in "$REFERENCING_PROCESSES"; do
            if [ -n "$REFERENCING_PROCESS" ] && ! is_staged "$REFERENCING_PROCESS"; then
                echo "$PROCESS references $REFERENCING_PROCESS and will be added, too."
                cmd_exec "$REFERENCING_PROCESS"
            fi
        done
    done
}

# $1    bpmn file
get_referenced_process_ids() {
    echo $(sed -rn 's/<.*(process|collaboration).*id="([^"]*)".*/\2/p' "$1");
}

# $1    id of process
get_referencing_processes() {
    grep -Rl "calledElement=\"$1\"" .
}

# $1    bpmn file name
is_staged() {
    for STAGED_FILE in $(git diff --name-only --cached); do
        if [ "$1" == "./$STAGED_FILE" ]; then
            return 0
        fi
    done

    return 1
}
